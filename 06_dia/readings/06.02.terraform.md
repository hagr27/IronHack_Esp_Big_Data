# Terraform + AWS - Guía Completa

---

## 1️⃣ Descargar e instalar Terraform

Descargar la versión 1.5.7:

```bash
curl -LO https://releases.hashicorp.com/terraform/1.5.7/terraform_1.5.7_linux_amd64.zip
unzip terraform_1.5.7_linux_amd64.zip
sudo mv terraform /usr/local/bin/
terraform version

# Borrado
find . -type f -name "*Zone.Identifier" -delete
```

---

## 2️⃣ Configurar AWS CLI

Verificar la región configurada:

```bash
aws --version # aws-cli/2.15.2 Python/3.11.0 Linux/5.15

# Instalar
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install

# Credenciales
aws configure
aws configure get region

# AWS Access Key ID [None]: <TU_ACCESS_KEY_ID>
# AWS Secret Access Key [None]: <TU_SECRET_ACCESS_KEY>
# Default region name [None]: <TU_REGION>      # Ejemplo: eu-north-1
# Default output format [None]: <formato>     # Ejemplo: json, table o text
```
- Access Key ID y Secret Access Key: se generan en IAM → Users → Security credentials → Create access key.
- Default region name: la región donde desplegarás tus recursos, ej. eu-north-1.
- Default output format: cómo quieres que se muestren los resultados (json recomendado).

```bash
# Verificar configuración
aws configure list
aws configure list-profiles

aws configure --profile dev_ironhack
aws configure get region --profile dev_ironhack

export AWS_PROFILE=dev_ironhack
```
```bash
# S3
aws s3 ls

# Eliminar todos los objetos (solo la versión actual)
aws s3 rm s3://ironhack-bucket-terraform-ag-1 --recursive

# Si el bucket tiene versionado, eliminar todas las versiones
aws s3api list-object-versions --bucket ironhack-bucket-terraform-ag-1 \
    --query 'Versions[].{Key:Key,VersionId:VersionId}' --output text | \
    while read key version; do
        aws s3api delete-object --bucket ironhack-bucket-terraform-ag-1 --key $key --version-id $version
    done
```

```bash
# Listar Key Pairs existentes:
aws ec2 describe-instances
aws ec2 describe-instances --query "Reservations[*].Instances[*].[InstanceId,State.Name,PublicIpAddress]" --output table
aws ec2 describe-instances --profile dev_ironhack  --query "Reservations[*].Instances[*].[InstanceId,State.Name,PublicIpAddress]" --output table
aws ec2 describe-instances \
    --filters "Name=instance-state-name,Values=running" \
    --query "Reservations[*].Instances[*].[InstanceId,PublicIpAddress,InstanceType,Tags[?Key=='Name'].Value | [0]]" \
    --output table
    
aws ec2 describe-key-pairs --query "KeyPairs[*].KeyName" --output table
```
---
# Comandos
```bash
### S3
# Listar todos los buckets S3 en tu cuenta
aws s3 ls
# Listar los objetos dentro de un bucket específico
aws s3 ls s3://nombre-de-tu-bucket
# Ver versión de objetos si el bucket tiene versionado activado
aws s3api list-object-versions --bucket nombre-de-tu-bucket

### Sincronizar carpetas
# Subir todo un directorio:
aws s3 sync ./mi_carpeta_local s3://ironhack-bucket-terraform-ag-1/
# Descargar todo el bucket a un directorio local:
aws s3 sync s3://ironhack-bucket-terraform-ag-1/ ./mi_carpeta_local


### EC2
ssh -i "~/.ssh/id_rsa" ec2-user@<EC2_PUBLIC_IP>
terraform output ec2_public_ip
chmod 600 ~/.ssh/id_rsa

aws s3 ls s3://ironhack-bucket-terraform-ag-1

# Listar todas las instancias EC2 en la región configurada
aws ec2 describe-instances
# Lista resumida con ID, estado y tipo de instancia
aws ec2 describe-instances --query "Reservations[*].Instances[*].[InstanceId,State.Name,InstanceType,PublicIpAddress]" --output table
# Filtrar por nombre de tag
aws ec2 describe-instances --filters "Name=tag:Name,Values=EC2-IronHack" --query "Reservations[*].Instances[*].[InstanceId,State.Name,PublicIpAddress]" --output table

```

```bash
#!/bin/bash
# ------------------------------------------------------------------
# Script de gestión de S3 para ironhack-bucket-terraform-ag-1
# ------------------------------------------------------------------

BUCKET="ironhack-bucket-terraform-ag-1"

echo "Selecciona una opción:"
echo "1️⃣ Listar archivos del bucket"
echo "2️⃣ Subir un archivo al bucket"
echo "3️⃣ Descargar un archivo del bucket"
echo "4️⃣ Salir"

read -p "Opción: " OPCION

case $OPCION in
  1)
    echo "Listando archivos en s3://$BUCKET..."
    aws s3 ls s3://$BUCKET --recursive
    ;;
  2)
    read -p "Ruta local del archivo a subir: " ARCHIVO
    if [ -f "$ARCHIVO" ]; then
      aws s3 cp "$ARCHIVO" s3://$BUCKET/
      echo "Archivo subido correctamente."
    else
      echo "El archivo no existe."
    fi
    ;;
  3)
    read -p "Nombre del archivo en el bucket a descargar: " ARCHIVO
    read -p "Ruta local donde guardarlo: " DESTINO
    aws s3 cp "s3://$BUCKET/$ARCHIVO" "$DESTINO"
    echo "Archivo descargado en $DESTINO"
    ;;
  4)
    echo "Saliendo..."
    exit 0
    ;;
  *)
    echo "Opción no válida."
    ;;
esac
```
---

## 3️⃣ Crear Key Pair en AWS

### Opción A: AWS Management Console

1. Ir a EC2 → Network & Security → Key Pairs → Create Key Pair.
2. Nombre: `ironhack-key`.
3. Formato: PEM.
4. Descargar `ironhack-key.pem` y guardarlo en un lugar seguro.

### Opción B: Desde Linux/WSL/PopOS

```bash
ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa
ls -l ~/.ssh/id_rsa*
```

* Clave privada: `~/.ssh/id_rsa` (no compartir)
* Clave pública: `~/.ssh/id_rsa.pub` (subir a AWS o usar en Terraform)

Conexión SSH a EC2 (después de lanzar la instancia):

```bash
ssh -i "~/.ssh/id_rsa" ec2-user@<EC2_PUBLIC_IP>
```

---

## 4️⃣ Terraform - Flujo de trabajo

1. Revisar procesos Terraform activos:

```bash
ps aux | grep terraform
```

2. Limpiar configuración previa (si es necesario):

```bash
rm -rf .terraform
```

3. Inicializar proyecto:

```bash
terraform init
```

4. Revisar plan de ejecución:

```bash
terraform plan
```

5. Aplicar cambios:

```bash
terraform apply
```

6. Aplicar cambios automáticamente:

```bash
terraform apply -auto-approve
```

7. Consultar outputs:

```bash
terraform output
```

8. Destruir infraestructura:

```bash
terraform destroy -auto-approve
```

---

## 5️⃣ Orden de creación de recursos en Terraform

1. Data sources (VPC)
2. S3 bucket
3. IAM Role
4. IAM Policy
5. IAM Role Policy Attachment
6. Security Group
7. Key Pair
8. Instance Profile
9. EC2 Instance
10. S3 Bucket versioning y ACL



----
----

1️⃣ Actualizar la instancia
sudo yum update -y  # Para Amazon Linux / RedHat
# o en Ubuntu:
# sudo apt update && sudo apt upgrade -y

2️⃣ Instalar Docker

Para Amazon Linux 2:

sudo amazon-linux-extras install docker -y
sudo service docker start
sudo systemctl enable docker


Para Ubuntu/Debian:

sudo apt install docker.io -y
sudo systemctl start docker
sudo systemctl enable docker

3️⃣ Añadir tu usuario al grupo docker

Esto permite ejecutar comandos Docker sin sudo:

sudo usermod -aG docker $USER


Luego cierra sesión y vuelve a entrar para que los cambios tengan efecto.

4️⃣ Verificar instalación
docker --version
docker run hello-world


Si ves un mensaje de “Hello from Docker!”, ya está listo.

5️⃣ Opcional: Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.21.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
docker-compose --version

6️⃣ Ejecutar Jupyter en Docker

Si quieres usar JupyterLab dentro de un contenedor:

docker run -p 8888:8888 -v /home/ec2-user/notebooks:/home/jovyan/work jupyter/base-notebook

- despues de ejecutar terraform
jupyter notebook --ip=0.0.0.0 --port=8888 --no-browser
